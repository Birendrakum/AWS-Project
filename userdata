#!/bin/bash
exec > /tmp/user-data.log 2>&1
echo "Starting user-data script..."

# Install git and clone your project
sudo yum install -y git
sudo -u ec2-user git clone -b master --single-branch https://github.com/Birendrakum/AWS-Project.git /home/ec2-user/AWS-Project

# Install Python3, pip, and jq (needed for JSON parsing)
sudo yum install -y python3 python3-pip jq

# Install Django and other Python packages
sudo -H pip3 install django boto3 django-storages[boto3]

# Go to the AWS-Project directory
cd /home/ec2-user/AWS-Project

# Navigate to the Django project directory
cd webpage_code/

# Fetch AWS secrets from Secrets Manager (replace "secret1" with your secret's ID)
SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id "secret1" --query "SecretString" --output text)

# Parse the secret JSON to get individual keys
ACCESS_KEY=$(echo $SECRET_JSON | jq -r '.Access_key')
SECRET_KEY=$(echo $SECRET_JSON | jq -r '.Secret_key')

# Inject the retrieved keys into your Django settings.py file
sudo sed -i "s/^AWS_ACCESS_KEY_ID\s*=.*/AWS_ACCESS_KEY_ID = '$ACCESS_KEY'/" /home/ec2-user/AWS-Project/Webpage_code/myproject/settings.py
sudo sed -i "s/^AWS_SECRET_ACCESS_KEY\s*=.*/AWS_SECRET_ACCESS_KEY = '$SECRET_KEY'/" /home/ec2-user/AWS-Project/Webpage_code/myproject/settings.py


# Apply Django migrations and start the Django server binding to all network interfaces
python3 manage.py makemigrations
python3 manage.py migrate
python3 manage.py runserver 0.0.0.0:8000

echo "Setup complete. Access your website using http://$PUBLIC_IP:8000"
